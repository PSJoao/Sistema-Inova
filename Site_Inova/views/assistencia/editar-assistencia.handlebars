{{!--
  views/assistencia/editar-assistencia.handlebars
  - Versão Final: Layout e estilo atualizados para serem idênticos à página de nova assistência.
--}}
<link rel="stylesheet" href="/public/styles/assistencia.css">

<div class="content-card">
    <div class="page-header-actions">
        <h1 class="page-title">{{title}}</h1>
    </div>

    <form action="/assistencias/update/{{assistencia.id}}" method="POST" id="form-edit-assistencia">

        <h5 class="form-section-title">Dados da Solicitação</h5>
        <div class="row mb-3">
            <div class="col-md-5" style="padding-bottom: 20px;">
                <label for="descricao" class="form-label" style="padding-right: 5px;">Categoria <span class="text-danger">*</span></label>
                <select id="descricao" name="descricao" class="form-control" style="max-width: 400px;" required>
                    <option value="PEÇA PARA CLIENTE" {{isSelected assistencia.descricao "PEÇA PARA CLIENTE"}}>PEÇA PARA CLIENTE</option>
                    <option value="PEÇA PARA REPOR VOLUME" {{isSelected assistencia.descricao "PEÇA PARA REPOR VOLUME"}}>PEÇA PARA REPOR VOLUME</option>
                    <option value="PEÇA PARA ESTOQUE" {{isSelected assistencia.descricao "PEÇA PARA ESTOQUE"}}>PEÇA PARA ESTOQUE</option>
                    <option value="PEÇA PARA CLIENTE LOJA FISICA" {{isSelected assistencia.descricao "PEÇA PARA CLIENTE LOJA FISICA"}}>PEÇA PARA CLIENTE LOJA FISICA</option>
                    <option value="PEÇA PARA MOSTRUÁRIO LOJA" {{isSelected assistencia.descricao "PEÇA PARA MOSTRUÁRIO LOJA"}}>PEÇA PARA MOSTRUÁRIO LOJA</option>
                </select>
            </div>
            <div class="col-md-4" style="padding-bottom: 20px;">
                <label for="solicitante_id" class="form-label">Solicitante <span class="text-danger">*</span></label>
                <div class="input-group" style="display: flex; flex-direction: row;">
                    <select id="solicitante_id" name="solicitante_id" class="form-control" style="max-width: 400px;" data-selected="{{assistencia.solicitante_id}}" required>
                        <option value="">Carregando...</option>
                    </select>
                    <button class="btn btn-outline-secondary" type="button" id="btn-add-solicitante" title="Adicionar Novo Solicitante">
                        <i class="fas fa-plus"></i> Novo Solicitante
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <label for="data_solicitacao" class="form-label">Data da Solicitação <span class="text-danger">*</span></label>
                <input type="date" id="data_solicitacao" name="data_solicitacao" class="form-control" value="{{formatDateYMD assistencia.data_solicitacao}}" required>
            </div>
        </div>

        <h5 class="form-section-title mt-4" style="padding-top: 20px;">Dados do Pedido</h5>
        <div class="row mb-3">
            <div class="col-md-4" style="padding-bottom: 20px;">
                <label for="nf_origem" class="form-label">NF Origem</label>
                <input type="text" id="nf_origem" name="nf_origem" class="form-control" value="{{assistencia.nf_origem}}">
            </div>
            <div class="col-md-5" style="padding-bottom: 20px;">
                <label for="nome_pedido" class="form-label">Nome do Cliente/Pedido <span class="text-danger">*</span></label>
                <input type="text" id="nome_pedido" name="nome_pedido" class="form-control" value="{{assistencia.nome_pedido}}" required>
            </div>
            <div class="col-md-3" style="padding-bottom: 20px;">
                <label for="documento_cliente" class="form-label">Documento do Cliente</label>
                <input type="text" id="documento_cliente" name="documento_cliente" class="form-control" value="{{assistencia.documento_cliente}}">
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4" style="padding-bottom: 20px;">
                <label for="numero_pedido_venda" class="form-label">Número do Pedido de Venda</label>
                <input type="text" id="numero_pedido_venda" name="numero_pedido_venda" class="form-control" value="{{assistencia.numero_pedido_venda}}">
            </div>
            <div class="col-md-2" style="padding-bottom: 20px;">
                <label for="coluna_estoque" class="form-label">Coluna</label>
                <input type="text" id="coluna_estoque" name="coluna_estoque" class="form-control" value="{{assistencia.coluna_estoque}}">
            </div>
            <div class="col-md-2" style="padding-bottom: 20px;">
                <label for="linha_estoque" class="form-label">Linha</label>
                <input type="text" id="linha_estoque" name="linha_estoque" class="form-control" value="{{assistencia.linha_estoque}}">
            </div>
        </div>
        <div class="row mb-3" style="padding-bottom: 20px;">
            <div class="col-md-12">
                <div style="display: flex; flex-direction: row; gap: 25px;">
                    <label for="observacoes" class="form-label">Observações</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="true" id="marcar_como_alerta" name="marcar_como_alerta" {{#if assistencia.marcar_como_alerta}}checked{{/if}}>
                        <label class="form-check-label" for="marcar_como_alerta">
                            Marcar como Alerta
                        </label>
                    </div>
                </div>
                <textarea id="observacoes" name="observacoes" class="form-control" rows="3">{{assistencia.observacoes}}</textarea>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4" style="padding-bottom: 20px;">
                <label for="fabrica_id" class="form-label">Fábrica <span class="text-danger">*</span></label>
                <div class="input-group" style="display: flex; flex-direction: row;">
                    <select id="fabrica_id" name="fabrica_id" class="form-control" style="max-width: 400px;" data-selected="{{assistencia.fabrica_id}}" required>
                        <option value="">Carregando...</option>
                    </select>
                    <button class="btn btn-outline-secondary" type="button" id="btn-add-fabrica" title="Adicionar Nova Fábrica">
                        <i class="fas fa-plus"></i> Nova Fábrica
                    </button>
                </div>
            </div>
            <div class="col-md-6" style="padding-bottom: 40px;">
                <label for="cor" class="form-label">Cor</label>
                <input type="text" id="cor" name="cor" class="form-control" value="{{assistencia.cor}}">
            </div>
        </div>

        <hr class="my-4">
        <div class="d-flex justify-content-between align-items-center mb-3" style="padding-top: 20px;">
            <h5 class="mb-0">Produtos e Peças Solicitadas</h5>
            <button type="button" id="btn-add-produto" class="btn btn-secondary btn-sm" style="margin-bottom: 15px;">
                <i class="fas fa-plus me-2"></i>Adicionar Produto
            </button>
        </div>
        <div id="produtos-container">
            {{#each assistencia.produtos as |produto pIndex|}}
                <div class="card mb-3 produto-bloco" id="produto-bloco-{{pIndex}}" data-status-volume="{{produto.status_volume}}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Volume {{addOne pIndex}}</h5>
                            <button type="button" class="btn btn-outline-danger btn-sm btn-remove-produto">Remover Volume</button>
                        </div>
                        
                        <div class="row align-items-end">
                             <div class="col-md-6">
                                <label class="form-label">Nome do Produto (ou SKU) <span class="text-danger">*</span></label>
                                <input type="text" name="produtos[{{pIndex}}][nome]" class="form-control sku-lookup" value="{{produto.nome_produto}}" required>
                                <input type="hidden" name="produtos[{{pIndex}}][sku]" value="{{produto.sku}}">
                            </div>
                            
                            {{!-- [CORREÇÃO] Campo de qualidade adicionado aqui --}}
                            {{#if (isStock ../assistencia.descricao)}}
                            <div class="col-md-4">
                                <label class="form-label">Qualidade do Volume</label>
                                <select name="produtos[{{pIndex}}][volume_qualidade]" class="form-select form-select-sm">
                                    <option value="Volume Bom" {{isSelected produto.volume_qualidade "Volume Bom"}}>Volume Bom</option>
                                    <option value="Volume Ruim" {{isSelected produto.volume_qualidade "Volume Ruim"}}>Volume Ruim</option>
                                </select>
                            </div>
                            {{/if}}
                        </div>

                        <div class="mt-3">
                            <label class="form-label">Peças</label>
                            <div class="pecas-container" id="pecas-container-{{pIndex}}">
                                {{#each produto.pecas}}
                                    <div class="input-group mb-2 peca-item">
                                        <input type="text" name="produtos[{{pIndex}}][pecas][]" class="form-control" value="{{this.nome_peca}}" required>
                                        <button class="btn btn-outline-danger btn-remove-peca" type="button">Remover Peça</button>
                                    </div>
                                {{/each}}
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2 btn-add-peca" data-produto-id="{{pIndex}}">+ Peça</button>
                        </div>
                    </div>
                </div>
            {{/each}}
        </div>

        <div class="d-flex justify-content-end mt-4">
            <a href="/assistencias/{{assistencia.id}}" class="btn btn-light me-2">Cancelar</a>
            <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        </div>
    </form>
</div>

{{#section "scripts"}}
    <script src="/public/scripts/editarAssistenciaManager.js"></script>
{{/section}}
