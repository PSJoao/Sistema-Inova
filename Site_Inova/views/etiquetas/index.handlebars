{{! views/etiquetas/index.handlebars }}
<link rel="stylesheet" href="/public/styles/etiquetas.css">

<div class="content-card">
    {{!-- Cabeçalho da Página --}}
    <div class="page-header-actions">
        <h1 class="page-title">Ordenador de Etiquetas</h1>
    </div>

    {{!-- Container para notificações (sucesso, erro) --}}
    <div id="notification-container">
        {{{_sections.messages}}}
        {{> messages }}
    </div>

    {{!-- Conteúdo da Aba --}}
    <div class="tab-content mt-3">
        <div class="tab-pane fade show active" role="tabpanel">
            
            <div class="upload-container">
                <p class="upload-description">
                    Faça o upload dos arquivos PDF de etiquetas (até 20 por vez) para organizá-los por SKU e gerar um novo PDF pronto para impressão.
                </p>

                {{! ----- MODIFICADO AQUI ----- }}
                <form id="etiquetasUploadForm" action="/etiquetas/processar" method="POST" enctype="multipart-form-data">
                    <div class="form-group">
                        <label for="etiquetasPdfs" class="form-label">Selecionar Arquivos PDF:</label>
                        <div class="custom-file-upload">
                            <input type="file" id="etiquetasPdfs" name="etiquetasPdfs" accept="application/pdf" multiple>
                            <label for="etiquetasPdfs" class="btn btn-secondary"><i class="fas fa-file-pdf"></i> Escolher Arquivos</label>
                        </div>
                        <small class="form-text">Você pode selecionar múltiplos arquivos (até 50 por vez).</small>
                    </div>

                    {{! ----- E AQUI ----- }}
                    <div id="etiquetasFileList" class="file-list"></div>

                    <button type="submit" class="btn btn-primary btn-block mt-3"><i class="fas fa-cogs"></i> Gerar PDF Organizado</button>
                </form>
            </div>

            <div class="search-container mt-4">
                 <h5 class="mb-3">Buscar Etiqueta Individual</h5>
                 <p class="search-description">
                    Digite o número da Nota Fiscal para buscar e baixar a etiqueta individual (se já tiver sido processada anteriormente).
                 </p>
                 <div class="form-row align-items-end">
                     <div class="col">
                        <label for="nfSearchInput" class="form-label">Número da NF:</label>
                        <input type="text" class="form-control" id="nfSearchInput" placeholder="Digite apenas números">
                     </div>
                     <div class="col-auto">
                        <button type="button" class="btn btn-info" id="nfSearchButton"><i class="fas fa-search"></i> Buscar Etiqueta</button>
                     </div>
                 </div>
                 <div id="searchResult" class="mt-2"></div>

                 <hr class="mt-4 mb-4">
                 <br>
                <div class="batch-search-container">
                    <h5 class="mb-3">Buscar Etiquetas por Lote (Excel)</h5>
                    <p class="search-description">
                        Faça o upload de um arquivo Excel (.xlsx, .xls) com os números das Notas Fiscais na <b>Coluna A</b> (a partir da linha 2) para gerar um PDF único com todas as etiquetas encontradas.
                    </p>
                    {{! Nota: Não é 'action' ou 'method' pois o JS vai cuidar disso }}
                    <form id="nfBatchUploadForm"> 
                        <div class="form-group">
                            <label for="nfExcelFile" class="form-label">Selecionar Arquivo Excel:</label>
                            <div class="custom-file-upload">
                            {{! O name 'nfExcelFile' deve bater com o multer no controller }}
                            <input type="file" id="nfExcelFile" name="nfExcelFile" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                                <label for="nfExcelFile" class="btn btn-secondary"><i class="fas fa-file-excel"></i> Escolher Arquivo</label>
                            </div>
                            <small id="nfExcelFileName" class="form-text text-muted"></small>
                        </div>
                        <button type="submit" class="btn btn-success btn-block mt-3"><i class="fas fa-file-pdf"></i> Gerar PDF por Lote</button>
                    </form>
                </div>
            </div>
            <br>
            <br>
            <hr class="mt-4 mb-4">
            <br>
            <br>
            <div class="card mt-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Bipagens realizadas no dia</h5>
                </div>
                <div class="card-body p-0">
                    {{#if recentFiles.length}}
                        <div class="list-group list-group-flush">
                            {{#each recentFiles}}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-file-pdf text-danger mr-2"></i>
                                        <strong>{{this.name}}</strong>
                                        <br>
                                        <small class="text-muted">Gerado em: {{formatDateShort this.date}}</small>
                                    </div>
                                    <a href="/etiquetas/recentes/{{this.name}}" class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="fas fa-download"></i> Baixar
                                    </a>
                                </div>
                            {{/each}}
                        </div>
                    {{else}}
                        <div class="p-3 text-center text-muted">
                            Nenhuma bipagem recente encontrada.
                        </div>
                    {{/if}}
                </div>
            </div>

        </div>
    </div>
</div>

{{#section "scripts"}}
  <script src="/public/scripts/etiquetasManager.js"></script>
{{/section}}